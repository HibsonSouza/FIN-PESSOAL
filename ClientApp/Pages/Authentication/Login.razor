@page "/login"
@layout Components.Layout.EmptyLayout
@using FinanceManager.ClientApp.Services.Interfaces
@using FinanceManager.ClientApp.Models

@inject IAuthenticationService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<div class="login-container">
    <MudCard Elevation="4" Class="px-4 py-8" Style="width: 100%; max-width: 450px;">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Gerenciador Financeiro</MudText>
                <MudText Typo="Typo.h5" Align="Align.Center">Login</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <EditForm Model="@loginModel" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                
                <MudTextField Label="Email" 
                            @bind-Value="loginModel.Email" 
                            For="@(() => loginModel.Email)"
                            Variant="Variant.Outlined" 
                            Margin="Margin.Dense"
                            FullWidth="true" 
                            Required="true"
                            InputType="InputType.Email"
                            Class="mb-4" />
                
                <MudTextField Label="Senha" 
                            @bind-Value="loginModel.Password" 
                            For="@(() => loginModel.Password)"
                            Variant="Variant.Outlined" 
                            Margin="Margin.Dense"
                            FullWidth="true" 
                            Required="true"
                            InputType="@(_passwordVisible ? InputType.Text : InputType.Password)"
                            Adornment="Adornment.End"
                            AdornmentIcon="@(_passwordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                            OnAdornmentClick="() => _passwordVisible = !_passwordVisible"
                            AdornmentAriaLabel="Mostrar senha"
                            Class="mb-2" />
                
                <MudCheckBox @bind-Checked="loginModel.RememberMe" Label="Lembrar-me" Color="Color.Primary" Class="mb-4" />
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           ButtonType="ButtonType.Submit" 
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="@_processing">
                    @if (_processing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Processando...</span>
                    }
                    else
                    {
                        <span>Entrar</span>
                    }
                </MudButton>
                
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
                }
            </EditForm>
            
            <MudDivider Class="my-4" />
            
            <MudStack Row="true" Justify="Justify.SpaceBetween">
                <MudLink Href="forgot-password" Underline="Underline.Always">Esqueceu sua senha?</MudLink>
                <MudLink Href="register" Underline="Underline.Always">Criar conta</MudLink>
            </MudStack>
        </MudCardContent>
    </MudCard>
</div>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        padding: 1rem;
    }
</style>

@code {
    private LoginModel loginModel = new LoginModel();
    private bool _processing = false;
    private bool _passwordVisible = false;
    private string _errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        // Verifica se já está autenticado
        if (AuthService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task HandleValidSubmit()
    {
        _processing = true;
        _errorMessage = string.Empty;

        try
        {
            var result = await AuthService.LoginAsync(loginModel);
            
            if (result.Success)
            {
                Snackbar.Add("Login realizado com sucesso!", Severity.Success);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                _errorMessage = result.Message ?? "Erro ao realizar login. Verifique suas credenciais.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Erro: {ex.Message}";
        }
        finally
        {
            _processing = false;
        }
    }
}